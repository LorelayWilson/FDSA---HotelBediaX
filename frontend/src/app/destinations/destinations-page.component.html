<div class="layout">
  <aside class="sidebar">
    <h3>Filtros</h3>
    <input 
      type="text" 
      placeholder="Buscar..." 
      [ngModel]="searchTerm"
      (ngModelChange)="onSearchChange($event)"
      (keyup.enter)="onSearch()" />
    <select [(ngModel)]="countryCode" (change)="onFilterChange()">
      <option value="">Todos los países</option>
      @for (country of countries(); track country) {
        <option [value]="country">{{ country }}</option>
      }
    </select>
    <select [(ngModel)]="type" (change)="onFilterChange()">
      <option value="">Todos los tipos</option>
      @for (destType of destinationTypes(); track destType) {
        <option [value]="destType">{{ getTypeLabel(destType) }}</option>
      }
    </select>
  </aside>

  <section class="content">
    <app-alert 
      [show]="alert().show" 
      [type]="alert().type" 
      [message]="alert().message"
      (dismissed)="onAlertDismissed()">
    </app-alert>
    
    <h2>Destinos Turísticos</h2>
    
    <app-loading [isLoading]="loading()"></app-loading>

    <div class="actions">
      <app-button variant="primary" (clicked)="onCreate()">Crear</app-button>
      <app-button variant="secondary" [disabled]="selectedId() === null" (clicked)="onEdit()">Editar</app-button>
      <app-button variant="danger" [disabled]="selectedId() === null" (clicked)="onRemove()">Eliminar</app-button>
    </div>

    <table>
      <thead>
        <tr>
          <th (click)="onSort('id')" [class.sortable]="true">ID <span class="sort-indicator" [class.active]="sortState()?.key === 'id'" [attr.data-dir]="sortState()?.dir"></span></th>
          <th (click)="onSort('name')" [class.sortable]="true">Nombre <span class="sort-indicator" [class.active]="sortState()?.key === 'name'" [attr.data-dir]="sortState()?.dir"></span></th>
          <th (click)="onSort('description')" [class.sortable]="true">Descripción <span class="sort-indicator" [class.active]="sortState()?.key === 'description'" [attr.data-dir]="sortState()?.dir"></span></th>
          <th (click)="onSort('countryCode')" [class.sortable]="true">País <span class="sort-indicator" [class.active]="sortState()?.key === 'countryCode'" [attr.data-dir]="sortState()?.dir"></span></th>
          <th (click)="onSort('type')" [class.sortable]="true">Tipo <span class="sort-indicator" [class.active]="sortState()?.key === 'type'" [attr.data-dir]="sortState()?.dir"></span></th>
          <th (click)="onSort('lastModif')" [class.sortable]="true">Modificado <span class="sort-indicator" [class.active]="sortState()?.key === 'lastModif'" [attr.data-dir]="sortState()?.dir"></span></th>
        </tr>
      </thead>
      <tbody>
        @for (destination of getSortedDestinations(); track destination.id) {
          <tr (click)="selectRow(destination.id!)" [class.selected]="selectedId() === destination.id">
            <td>{{ destination.id }}</td>
            <td><a [routerLink]="['/destinations', destination.id]" (click)="$event.stopPropagation()" class="destination-link">{{ destination.name }}</a></td>
            <td>{{ destination.description }}</td>
            <td>{{ destination.countryCode }}</td>
            <td>{{ getTypeLabel(destination.type?.toString() || '') }}</td>
            <td>{{ destination.lastModif | date:'dd/MM/yyyy' }}</td>
          </tr>
        }
      </tbody>
    </table>

    <div class="pagination">
      <app-button variant="secondary" [disabled]="!canGoToPreviousPage()" (clicked)="changePage(-1)">Anterior</app-button>
      <span>Página {{ filter().page || 1 }} | Total: {{ totalCount() }}</span>
      <app-button variant="secondary" [disabled]="!canGoToNextPage()" (clicked)="changePage(1)">Siguiente</app-button>
      
      <div class="page-size-selector">
        <label>Mostrar:</label>
        <select [(ngModel)]="pageSize" (change)="onPageSizeChange()">
          @for (size of pageSizeOptions; track size) {
            <option [value]="size">{{ size }}</option>
          }
        </select>
      </div>
    </div>
  </section>
</div>

<app-modal [show]="isModalOpen()" [title]="isEditing() ? 'Editar destino' : 'Crear destino'" (closed)="onModalClose()">
  <form (ngSubmit)="onSubmitForm()" #destForm="ngForm">
    <div class="form-grid">
      <label>
        Nombre
        <input name="name" [(ngModel)]="formModel.name" required />
      </label>

      <label>
        Descripción
        <textarea name="description" [(ngModel)]="formModel.description" rows="3" required></textarea>
      </label>

      <label>
        País
        <select name="countryCode" [(ngModel)]="formModel.countryCode" required>
          <option value="" disabled>Selecciona un país</option>
          @for (country of countries(); track country) {
            <option [value]="country">{{ country }}</option>
          }
        </select>
      </label>

      <label>
        Tipo
        <select name="type" [(ngModel)]="formModel.type" required>
          @for (destType of destinationTypes(); track destType; let i = $index) {
            <option [ngValue]="i">{{ getTypeLabel(i) }}</option>
          }
        </select>
      </label>
    </div>

    <div modal-actions>
      <app-button variant="secondary" (clicked)="onModalClose()" type="button">Cancelar</app-button>
      <app-button variant="primary" type="submit">Guardar</app-button>
    </div>
  </form>
</app-modal>

<app-confirm 
  [show]="isConfirmOpen()" 
  [title]="confirmData()?.title || ''"
  [message]="confirmData()?.message || ''"
  variant="danger"
  confirmText="Eliminar"
  cancelText="Cancelar"
  (confirmed)="onConfirmAction()"
  (cancelled)="onConfirmClose()">
</app-confirm>

